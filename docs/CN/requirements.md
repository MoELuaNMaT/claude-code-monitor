# 需求文档

## 项目概述

Claude Code Monitor 是一个 VSCode 扩展，提供对 Claude Code 终端活动的实时监控，重点关注 API 配额使用、插件状态和执行跟踪。

## 用户故事

### 故事 1：API 配额监控

**作为** Claude Code 用户
**我想要** 实时查看我的 API 配额使用情况
**以便** 避免超出订阅限制

**验收标准**：
- 显示每个已配置 API 提供商的配额使用情况
- 显示进度条和百分比
- 颜色编码警告（绿色 < 50%，黄色 50-80%，红色 > 80%）
- 每 5 分钟自动刷新
- 手动刷新按钮

### 故事 2：终端活动监控

**作为** Claude Code 用户
**我想要** 实时查看终端中的活动
**以便** 了解 Claude Code 正在做什么

**验收标准**：
- 显示工具调用（[Bash]、[Read] 等）
- 显示技能调用
- 显示代理操作
- 高亮显示用户消息
- 显示每个事件的时间戳

### 故事 3：插件管理

**作为** Claude Code 用户
**我想要** 查看已安装的插件
**以便** 管理我的 Claude Code 扩展

**验收标准**：
- 列出所有已安装的插件
- 显示插件版本
- 显示安装范围（用户/本地）
- 显示安装路径

### 故事 4：Plan 进度跟踪

**作为** Claude Code 用户
**我想要** 查看 Plan 模式执行进度
**以便** 知道还有多少工作要做

**验收标准**：
- 显示当前步骤 / 总步骤数
- 显示每个步骤的完成状态
- 高亮显示当前步骤

## 功能需求

### FR-1：配额监控

| ID | 需求 | 优先级 |
|----|------|--------|
| FR-1.1 | 支持 Anthropic API 配额监控 | 高 |
| FR-1.2 | 支持 GLM/智谱 API 配额监控 | 高 |
| FR-1.3 | 显示已用/限额/百分比 | 高 |
| FR-1.4 | 每 5 分钟自动刷新 | 中 |
| FR-1.5 | 手动刷新按钮 | 中 |
| FR-1.6 | 颜色编码进度条 | 高 |

### FR-2：活动监控

| ID | 需求 | 优先级 |
|----|------|--------|
| FR-2.1 | 实时监控终端输出 | 高 |
| FR-2.2 | 解析工具调用 | 高 |
| FR-2.3 | 解析技能调用 | 高 |
| FR-2.4 | 解析代理调用 | 高 |
| FR-2.5 | 高亮显示用户消息 | 中 |
| FR-2.6 | 显示事件时间戳 | 中 |
| FR-2.7 | 清除事件按钮 | 低 |

### FR-3：插件管理

| ID | 需求 | 优先级 |
|----|------|--------|
| FR-3.1 | 读取 installed_plugins.json | 高 |
| FR-3.2 | 显示插件列表 | 高 |
| FR-3.3 | 显示插件元数据 | 中 |

### FR-4：Plan 进度

| ID | 需求 | 优先级 |
|----|------|--------|
| FR-4.1 | 解析 Plan 模式输出 | 中 |
| FR-4.2 | 计算步骤进度 | 中 |
| FR-4.3 | 显示进度指示器 | 低 |

## 非功能需求

### NFR-1：性能

| ID | 需求 | 指标 |
|----|------|------|
| NFR-1.1 | UI 响应性 | < 100ms |
| NFR-1.2 | 内存使用 | < 50MB |
| NFR-1.3 | CPU 使用 | 空闲时 < 5% |

### NFR-2：可靠性

| ID | 需求 | 指标 |
|----|------|------|
| NFR-2.1 | 扩展稳定性 | 24 小时使用无崩溃 |
| NFR-2.2 | API 故障处理 | 优雅降级 |
| NFR-2.3 | 缓存有效期 | 5 分钟 |

### NFR-3：易用性

| ID | 需求 | 指标 |
|----|------|------|
| NFR-3.1 | 安装时间 | < 2 分钟 |
| NFR-3.2 | 首次使用配置 | 自动（零配置） |
| NFR-3.3 | 学习曲线 | 最小（直观的 UI） |

### NFR-4：兼容性

| ID | 需求 | 版本 |
|----|------|------|
| NFR-4.1 | VSCode | >= 1.85.0 |
| NFR-4.2 | Node.js | >= 16.x |
| NFR-4.3 | Claude Code CLI | 最新 |
| NFR-4.4 | 操作系统 | Windows、macOS、Linux |

## 数据需求

### DR-1：配置文件

| 文件 | 位置 | 用途 |
|------|------|------|
| installed_plugins.json | ~/.claude/ | 插件列表 |
| settings.json | ~/.claude/ | Claude Code 配置 |
| history.jsonl | ~/.claude/ | Token 使用历史 |

### DR-2：API 端点

| 提供商 | 端点 | 用途 |
|--------|------|------|
| GLM | /api/monitor/usage/quota/limit | 配额数据 |
| Anthropic | N/A | 无公开 API |

## 技术约束

### TC-1：架构

- 必须是 VSCode 扩展（不是独立应用）
- 必须使用 Webview 作为 UI
- 不得干扰 Claude Code 操作

### TC-2：安全

- 不得暴露 API 密钥
- 必须尊重用户隐私
- 必须安全处理敏感数据

### TC-3：维护

- 代码必须有良好文档
- 必须遵循 VSCode 扩展最佳实践
- 必须易于扩展新提供商
